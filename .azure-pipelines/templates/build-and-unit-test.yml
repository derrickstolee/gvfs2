steps:

  - script: $(Build.Repository.LocalPath)\scripts\NukeBuildOutputs.bat
    displayName: Delete previous build outputs
    continueOnError: true

  - powershell: |
      & 'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.6.1 Tools\sn.exe' -Vr *,31bf3856ad364e35
      & 'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.6.1 Tools\x64\sn.exe' -Vr *,31bf3856ad364e35
    displayName: Disable strong name validation for MS delay-signed assemblies

  - script: $(Build.Repository.LocalPath)\scripts\Build.bat $(configuration) $(majorAndMinorVersion).$(revision)
    displayName: Run VFSForGit build script ($(configuration))

  - script: $(Build.Repository.LocalPath)\scripts\RunUnitTests.bat $(configuration)
    displayName: Run unit tests

  - task: PublishTestResults@2
    displayName: Publish unit test results
    inputs:
      testRunner: NUnit
      testResultsFiles: "**\\TestResult.xml"
      searchFolder: $(System.DefaultWorkingDirectory)
      testRunTitle: Unit Tests ($(configuration))
      publishRunAttachments: true

  - script: $(Build.Repository.LocalPath)\scripts\CreateBuildArtifacts.bat $(configuration) $(Build.ArtifactStagingDirectory)
    displayName: Create build artifacts

  - task: PublishBuildArtifacts@1
    displayName: Publish functional tests drop artifact
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)\GVFS.FunctionalTests
      artifactName: "FunctionalTests_$(configuration)"
      parallel: true
      parallelCount: 8
    condition: succeededOrFailed()

  - task: PublishBuildArtifacts@1
    displayName: Publish FastFetch drop artifact
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)\FastFetch
      artifactName: "FastFetch_$(configuration)"
      parallel: true
      parallelCount: 8
    condition: succeededOrFailed()

  - task: PublishBuildArtifacts@1
    displayName: Publish installer drop artifact
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)\GVFS.Installer
      artifactName: "Installer_$(configuration)"
      parallel: true
      parallelCount: 8
    condition: succeededOrFailed()
